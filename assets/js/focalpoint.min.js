!function(t,e,a){function o(t,e,a){let o=t;return t<e?o=e:t>a&&(o=a),o}const n="image-focal",c="image-focal__wrapper",i="image-focal__img",s="image-focal__point",f="image-focal__clickarea",l="image-focal__button",u="button",r="button-primary",d="button-disabled";t.imageFocal=t.imageFocal||{},t.imageFocal.focalPoint=function(h,m){const p=this;let v,g;p.$el=t(h),p.el=h,p.$el.data("imageFocal.focalPoint",p),p.init=function(){p.options=t.extend({},t.imageFocal.focalPoint.defaultOptions,m),p.addInterfaceElements(),p.attachment.init(),p.focusInterface.init(),p.saveButton.init(),t(a).on("resize",p.attachment.updateDimensionData)},p.addInterfaceElements=function(){const e=t(".edit-attachment-frame .attachment-media-view .details-image");e.addClass(i),e.wrap(`<div class="${n}"><div class="${c}"></div></div>`);const a=t(`.${c}`);a.append(`<div class="${s}"></div>`),a.append(`<div class="${f}"></div>`),v=t(`.${n}`),g=t(`.${f}`)},p.attachment={$el:!1,id:!1,width:!1,height:!1,offset:{x:!1,y:!1},focalPoint:{x:50,y:50},init(){p.attachment.$el=t(`.${i}`),p.attachment.getData(),p.attachment.$el.load((()=>{p.attachment.updateDimensionData()}))},getData(){p.attachment.id=t(p.el).find("#attachment-id").data("id");const e={id:p.attachment.id};t.ajax({type:"POST",url:ajaxurl,data:{action:"get_focal_point",attachment:e},dataType:"json"}).always((t=>{if(!0===t.success&&t.data&&t.data.focal_point)try{if(void 0===t.data.focal_point.x||void 0===t.data.focal_point.y)throw new Error("no coordinates");p.attachment.focalPoint=t.data.focal_point}catch(t){console.log(t)}p.attachment.updateDimensionData(),p.focusInterface.updateStylePosition(),p.focusInterface.$el.css({display:"block"}),p.focusInterface.updateDimensionData(),p.focusInterface.updateStyleBackground()}))},updateDimensionData(){const t=p.attachment.$el;p.attachment.width=t.width(),p.attachment.height=t.height(),p.attachment.offset.x=t.offset().left,p.attachment.offset.y=t.offset().top}},p.focusInterface={$el:!1,width:0,height:0,radius:0,offset:{x:0,y:0},position:{x:0,y:0},clickPosition:{x:0,y:0},state:{move:!1,active:!1,hover:!1},init(){p.focusInterface.$el=t(`.${s}`),g.on("mousedown",(t=>{1===t.which&&p.focusInterface.startMove(t,!0).move(t)})),p.focusInterface.$el.on("mousedown",(t=>{1===t.which&&p.focusInterface.startMove(t)})).on("mouseenter",(()=>{p.focusInterface.hover(!0)})).on("mouseleave",(()=>{p.focusInterface.hover(!1)})),t(e).on("mouseup",(t=>{1===t.which&&(p.focusInterface.state.move=!1,p.focusInterface.state.active=!1,v.removeClass("is-active"))})).on("mousemove",(t=>{p.focusInterface.move(t)})).on("resize",(()=>{p.focusInterface.updateDimensionData().updateStyle()}))},startMove(t,e){return p.attachment.updateDimensionData(),p.focusInterface.updateDimensionData().updateClickPosition(t,e),p.saveButton.highlight(),v.addClass("is-active"),p.focusInterface.state.move=!0,p.focusInterface.state.active=!0,this},move(t){if(!1===p.focusInterface.state.move)return!1;const e={},a=p.attachment.offset,n=p.focusInterface.clickPosition;return e.x=t.pageX-a.x-n.x,e.y=t.pageY-a.y-n.y,e.x=o(e.x,0,p.attachment.width),e.y=o(e.y,0,p.attachment.height),p.attachment.focalPoint={x:e.x/p.attachment.width*100,y:e.y/p.attachment.height*100},p.focusInterface.position=e,p.focusInterface.updateStyle(),this},updateStyle(){return p.focusInterface.updateStylePosition(),p.focusInterface.updateStyleBackground(),this},updateStylePosition(){return p.focusInterface.$el.css({left:`${p.attachment.focalPoint.x}%`,top:`${p.attachment.focalPoint.y}%`}),this},updateStyleBackground(){const t=0-(p.focusInterface.position.x-p.focusInterface.radius),e=0-(p.focusInterface.position.y-p.focusInterface.radius);return p.focusInterface.$el.css({backgroundImage:`url("${p.attachment.$el.attr("src")}")`,backgroundSize:`${p.attachment.width}px ${p.attachment.height}px`,backgroundPosition:`${t}px ${e}px `}),this},updateClickPosition(t,e){const a={x:0,y:0};if(!0!==e){const e=p.focusInterface.offset;a.x=t.pageX-e.x,a.y=t.pageY-e.y}return p.focusInterface.clickPosition=a,this},updateDimensionData(){p.focusInterface.width=p.focusInterface.$el.width(),p.focusInterface.height=p.focusInterface.$el.height();const t=p.focusInterface.width/2;p.focusInterface.radius=t;const e=p.focusInterface.$el.offset();return p.focusInterface.offset={x:e.left+t,y:e.top+t},p.focusInterface.position={x:p.attachment.focalPoint.x/100*p.attachment.width,y:p.attachment.focalPoint.y/100*p.attachment.height},this},hover(t){p.focusInterface.state.hover=t,v.toggleClass("is-hover",t)}},p.saveButton={$el:!1,isSaving:!1,init(){const e=`<button type="button" class="${u} ${d} crop-attachment ${l}">${focalPointL10n.saveButton}</button>`;t(p.el).find(".attachment-actions").append(e),p.saveButton.$el=t(`.${l}`),p.saveButton.$el.on("click",p.sendImageCropDataByAjax)},highlight(){p.saveButton.$el.removeClass(d).addClass(r).text(focalPointL10n.saveButton)},activate(){p.saveButton.$el.removeClass(d).removeClass(r)},disable(){p.saveButton.$el.removeClass(r).addClass(d)}},p.sendImageCropDataByAjax=function(){const e={id:p.attachment.id,focal_point:p.attachment.focalPoint};t.ajax({type:"POST",url:ajaxurl,data:{action:"set_focal_point",attachment:e},dataType:"json",beforeSend:()=>!0!==p.saveButton.isSaving&&(p.saveButton.$el.text(focalPointL10n.saving),p.saveButton.disable(),p.saveButton.isSaving=!0,!0)}).always((t=>{let e=focalPointL10n.saved;!0!==t.success&&(p.saveButton.activate(),e=focalPointL10n.tryAgain),p.saveButton.$el.text(e),p.saveButton.isSaving=!1}))}},t.imageFocal.focalPoint.defaultOptions={myDefaultValue:""},t.fn.initFocalPoint=function(e){return this.each((function(){new t.imageFocal.focalPoint(this,e).init()}))},t(a).on("ready",(()=>{e.setInterval((()=>{const e=t(".attachment-details");if(e.find(".details-image").length&&!t(".image-focal").length)try{e.initFocalPoint()}catch(t){console.log(t)}}),500)}))}(jQuery,window,document);